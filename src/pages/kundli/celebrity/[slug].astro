---
import ReportLayout from '../../../layouts/ReportLayout.astro';
import NorthIndianChart from '../../../components/charts/NorthIndianChart';
import DashaTimeline from '../../../components/report/DashaTimeline';
import { RASHI_ENGLISH, planetIconSvg } from '../../../lib/constants';
import { computeYogas, YOGA_CATEGORY_LABELS } from '../../../lib/yoga-engine';
import type { YogaCategory } from '../../../lib/yoga-engine';
import { computeTransits } from '../../../lib/compute-transits';
import TransitSection from '../../../components/report/TransitSection';
import ShareButton from '../../../components/report/ShareButton';
import { computeAllVargaCharts } from '../../../lib/divisional-charts';
import type { ChartData, Panchang as PanchangType, GrahaId, RashiId } from '../../../lib/types';
import type { VargaChartResult } from '../../../lib/divisional-charts';
import { computeKundli } from '../../../lib/compute-kundli';
import { getPanchangByDate } from '../../../lib/db/panchang';
import { mockPanchang } from '../../../lib/mock-data';
import { celebrities, getCelebrityBySlug, CATEGORY_LABELS } from '../../../data/celebrities';
import type { CelebrityEntry } from '../../../data/celebrities';

const { slug } = Astro.params;
const celeb = slug ? getCelebrityBySlug(slug) : undefined;

if (!celeb) {
  return Astro.redirect('/kundli/celebrity');
}

const computed = await computeKundli({
  dob: celeb.dob,
  time: celeb.time,
  lat: celeb.lat,
  lon: celeb.lon,
  timezone: celeb.timezone,
});

if (!computed) {
  return Astro.redirect('/kundli/celebrity');
}

const panchang = await getPanchangByDate(celeb.dob);

const MONTHS = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
function formatDOB(iso: string): string {
  const [y, m, d] = iso.split('-').map(Number);
  if (!d || !m) return iso;
  return `${d} ${MONTHS[m - 1]} ${y}`;
}

const name = celeb.name;
const formattedDOB = formatDOB(celeb.dob);
const city = celeb.city;

const panchangData: PanchangType = panchang ?? mockPanchang;
const chartData: ChartData = computed.chartData;
const dashaData = computed.dasha;

const DASHA_COLORS: Record<string, string> = {
  Sun: '#ea580c', Moon: '#7c3aed', Mars: '#e11d48', Mercury: '#059669',
  Jupiter: '#d97706', Venus: '#ec4899', Saturn: '#475569',
  Rahu: '#2563eb', Ketu: '#6366f1',
};

// ── Planet rows ──
interface PlanetRow {
  graha: GrahaId;
  sign: string;
  signSanskrit: string;
  degree: number;
  house: number;
  retrograde: boolean;
}
const planetRows: PlanetRow[] = [];
const PLANET_ORDER: GrahaId[] = ['Sun','Moon','Mars','Mercury','Jupiter','Venus','Saturn','Rahu','Ketu'];
for (let h = 1; h <= 12; h++) {
  const house = chartData.houses[h];
  if (!house?.planets) continue;
  for (const p of house.planets) {
    planetRows.push({
      graha: p.graha,
      sign: RASHI_ENGLISH[house.rashi] ?? String(house.rashi),
      signSanskrit: String(house.rashi),
      degree: p.degree,
      house: h,
      retrograde: p.retrograde ?? false,
    });
  }
}
planetRows.sort((a, b) => PLANET_ORDER.indexOf(a.graha) - PLANET_ORDER.indexOf(b.graha));

// ── Full Dasha timeline ──
const VIMSHOTTARI_SEQ = ['Ketu','Venus','Sun','Moon','Mars','Rahu','Jupiter','Saturn','Mercury'];
const VIMSHOTTARI_YEARS: Record<string, number> = {
  Ketu: 7, Venus: 20, Sun: 6, Moon: 10, Mars: 7, Rahu: 18, Jupiter: 16, Saturn: 19, Mercury: 17,
};
const _MS_YEAR = 365.25 * 24 * 3600 * 1000;

function _parseDate(s: string): number {
  const parts = s.split(' ');
  if (parts.length !== 3) return Date.now();
  return new Date(Number(parts[2]), MONTHS.indexOf(parts[1]), Number(parts[0])).getTime();
}
function _fmtDate(ms: number): string {
  const dt = new Date(ms);
  return `${dt.getDate()} ${MONTHS[dt.getMonth()]} ${dt.getFullYear()}`;
}
function _fmtDur(y: number): string {
  if (y >= 1) return `${y.toFixed(1)}y`;
  const m = y * 12;
  if (m >= 1) return `${Math.round(m)}m`;
  return `${Math.round(y * 365)}d`;
}

const _curMaha = dashaData.periods[0]?.planet ?? '';
const _curAntar = dashaData.periods[1]?.planet ?? '';
const _curMahaStartMs = _parseDate(dashaData.periods[0]?.start ?? '');
const _curMahaEndMs = _parseDate(dashaData.periods[0]?.end ?? '');
const _curMahaIdx = VIMSHOTTARI_SEQ.indexOf(_curMaha);
const _nowMs = Date.now();

const _allMaha: { planet: string; startMs: number; endMs: number; years: number }[] = [];
const _back: typeof _allMaha = [];
let _bc = _curMahaStartMs;
for (let i = 1; i <= 8; i++) {
  const idx = ((_curMahaIdx - i) % 9 + 9) % 9;
  const p = VIMSHOTTARI_SEQ[idx];
  const yr = VIMSHOTTARI_YEARS[p];
  const e = _bc; const s = e - yr * _MS_YEAR;
  _back.unshift({ planet: p, startMs: s, endMs: e, years: yr });
  _bc = s;
}
_allMaha.push(..._back);
_allMaha.push({ planet: _curMaha, startMs: _curMahaStartMs, endMs: _curMahaEndMs, years: VIMSHOTTARI_YEARS[_curMaha] ?? 0 });
let _fc = _curMahaEndMs;
for (let i = 1; i <= 8; i++) {
  const idx = (_curMahaIdx + i) % 9;
  const p = VIMSHOTTARI_SEQ[idx];
  const yr = VIMSHOTTARI_YEARS[p];
  const s = _fc; const e = s + yr * _MS_YEAR;
  _allMaha.push({ planet: p, startMs: s, endMs: e, years: yr });
  _fc = e;
}

const [_by, _bm, _bd] = celeb.dob.split('-').map(Number);
const _birthMs = new Date(_by, _bm - 1, _bd).getTime();
let _fi = _allMaha.findIndex(e => e.startMs <= _birthMs && e.endMs > _birthMs);
if (_fi < 0) _fi = Math.max(0, _allMaha.length - 9);
const _lifeMahasRaw = _allMaha.slice(_fi, _fi + 9);
const _lifeMahas = _lifeMahasRaw.map((m, idx) => {
  if (idx === 0 && m.startMs < _birthMs) {
    const remainingYears = (m.endMs - _birthMs) / _MS_YEAR;
    return { ...m, startMs: _birthMs, years: Math.round(remainingYears * 10) / 10 };
  }
  return m;
});

import type { MahaEntry, AntarEntry } from '../../../components/report/DashaTimeline';
const mahasTimeline: MahaEntry[] = _lifeMahas.map((maha, mi) => {
  const mIdx = VIMSHOTTARI_SEQ.indexOf(maha.planet);
  const fullYears = VIMSHOTTARI_YEARS[maha.planet] ?? 0;
  const origRaw = _lifeMahasRaw[mi];
  const origStart = origRaw.startMs;
  const isFirstClipped = mi === 0 && origStart < _birthMs;

  const allAntars: AntarEntry[] = [];
  let ac = origStart;
  for (let i = 0; i < 9; i++) {
    const idx = (mIdx + i) % 9;
    const p = VIMSHOTTARI_SEQ[idx];
    const durY = (fullYears * (VIMSHOTTARI_YEARS[p] ?? 0)) / 120;
    const durMs = durY * _MS_YEAR;
    const s = ac; const e = ac + durMs;
    allAntars.push({
      planet: p,
      duration: _fmtDur(durY),
      startMs: s,
      endMs: e,
      start: _fmtDate(s),
      end: _fmtDate(e),
      isCurrent: maha.planet === _curMaha && p === _curAntar && s <= _nowMs && e > _nowMs,
      mahaYears: fullYears,
    });
    ac = e;
  }

  let antars = allAntars;
  if (isFirstClipped) {
    antars = allAntars
      .filter(a => a.endMs > _birthMs)
      .map((a, ai) => {
        if (ai === 0 && a.startMs < _birthMs) {
          const remainY = (a.endMs - _birthMs) / _MS_YEAR;
          return { ...a, startMs: _birthMs, start: _fmtDate(_birthMs), duration: _fmtDur(remainY) };
        }
        return a;
      });
  }

  return {
    planet: maha.planet,
    years: maha.years,
    start: _fmtDate(maha.startMs),
    end: _fmtDate(maha.endMs),
    isCurrent: maha.planet === _curMaha,
    antars,
  };
});

// Yogas
const yogaResults = computeYogas(chartData);
const yogasByCategory = new Map<YogaCategory, typeof yogaResults>();
for (const y of yogaResults) {
  const list = yogasByCategory.get(y.category) ?? [];
  list.push(y);
  yogasByCategory.set(y.category, list);
}
const categoryOrder: YogaCategory[] = ['mahapurusha', 'raja', 'dhana', 'lunar', 'special', 'dosha'];
const yogaCatDesc: Record<string, string> = {
  mahapurusha: 'Formed when Mars, Mercury, Jupiter, Venus, or Saturn occupies a Kendra in own/exalted sign',
  raja: 'Kendra and Trikona lords connecting — the hallmark of power and authority',
  dhana: 'Planetary combinations indicating wealth accumulation and financial prosperity',
  lunar: 'Yogas formed based on the Moon\'s relationship with surrounding planets',
  special: 'Rare and notable combinations with unique effects on the native\'s life',
  dosha: 'Challenging planetary placements that may require awareness and remedies',
};

// Transits
const transitResult = await computeTransits(chartData);

// Divisional Charts
const vargaCharts = computeAllVargaCharts(chartData);

const RASHI_ORDER_FULL: RashiId[] = ['Mesha','Vrishabha','Mithuna','Karka','Simha','Kanya','Tula','Vrishchika','Dhanu','Makara','Kumbha','Meena'];
function vargaToChartData(vc: VargaChartResult): ChartData {
  const lagnaIdx = RASHI_ORDER_FULL.indexOf(vc.lagna);
  const houses: ChartData['houses'] = {} as ChartData['houses'];
  for (let i = 1; i <= 12; i++) {
    const rashiIdx = (lagnaIdx + i - 1) % 12;
    houses[i] = { rashi: RASHI_ORDER_FULL[rashiIdx], planets: [] };
  }
  for (const p of vc.planets) {
    if (houses[p.house]) {
      houses[p.house].planets.push({ graha: p.graha, degree: p.degree, retrograde: p.retrograde });
    }
  }
  return { lagna: vc.lagna, houses, chartName: vc.def.id, chartType: vc.def.name };
}

const reportTabs = [
  { id: 'overview', label: 'Overview' },
  { id: 'planets', label: 'Planets' },
  { id: 'dasha', label: 'Dasha Timeline' },
  { id: 'yogas', label: 'Yogas' },
  { id: 'transits', label: 'Transits' },
  { id: 'divisional', label: 'Divisional Charts' },
];

const seoTitle = `${name} Kundli – Birth Chart, Yogas & Dasha | StarYaar`;
const seoDesc = `Explore ${name}'s complete Vedic birth chart (Kundli). Born ${formattedDOB} in ${city}. View planetary positions, Dasha timeline, Yogas, transits and divisional charts.`;
const canonicalUrl = `https://staryaar.com/kundli/celebrity/${celeb.slug}`;

const lagnaEnglish = RASHI_ENGLISH[chartData.lagna] ?? chartData.lagna;
const moonHouse = planetRows.find(p => p.graha === 'Moon');
const moonSign = moonHouse?.sign ?? '';

const timeLabel = celeb.timeNote ? `${celeb.time} (${celeb.timeNote})` : celeb.time;
const timeAccuracyLabel = { AA: 'Very reliable', A: 'Reliable', B: 'Approximate', C: 'Uncertain', DD: 'Conflicting' }[celeb.timeSource];
---

<ReportLayout title={seoTitle} wide={true}>
  <Fragment slot="head">
    <meta name="description" content={seoDesc} />
    <link rel="canonical" href={canonicalUrl} />
    <meta property="og:title" content={seoTitle} />
    <meta property="og:description" content={seoDesc} />
    <meta property="og:url" content={canonicalUrl} />
    <meta property="og:type" content="article" />
    <meta name="twitter:card" content="summary" />
    <meta name="twitter:title" content={seoTitle} />
    <meta name="twitter:description" content={seoDesc} />
    <script type="application/ld+json" set:html={JSON.stringify({
      "@context": "https://schema.org",
      "@type": "Article",
      "headline": `${name} Kundli – Vedic Birth Chart`,
      "description": seoDesc,
      "url": canonicalUrl,
      "author": { "@type": "Organization", "name": "StarYaar" },
      "about": { "@type": "Person", "name": name, "birthDate": celeb.dob, "birthPlace": { "@type": "Place", "name": city } },
    })} />
  </Fragment>

  <!-- Breadcrumb -->
  <nav class="text-xs text-muted-foreground mb-4" aria-label="Breadcrumb">
    <ol class="flex items-center gap-1.5">
      <li><a href="/" class="hover:text-foreground transition-colors">Home</a></li>
      <li class="text-muted-foreground/50">/</li>
      <li><a href="/kundli/celebrity" class="hover:text-foreground transition-colors">Celebrity Charts</a></li>
      <li class="text-muted-foreground/50">/</li>
      <li class="text-foreground font-medium">{name}</li>
    </ol>
  </nav>

  <!-- Celebrity header -->
  <div class="bg-card border border-border rounded-xl px-4 md:px-6 py-5 md:py-6 mb-6 md:mb-8">
    <div class="flex flex-col md:flex-row md:items-start md:justify-between gap-4">
      <div>
        <span class="text-xs font-semibold text-primary uppercase tracking-wider">{CATEGORY_LABELS[celeb.category]}</span>
        <h1 class="text-2xl md:text-3xl font-bold text-foreground tracking-tight mt-1">{name}'s Kundli</h1>
        <p class="text-muted-foreground text-sm mt-2 max-w-2xl leading-relaxed">{celeb.bio}</p>
        <div class="flex flex-wrap gap-x-5 gap-y-1 mt-3 text-xs text-muted-foreground">
          <span><strong class="text-foreground">Born:</strong> {formattedDOB}</span>
          <span><strong class="text-foreground">Time:</strong> {timeLabel}</span>
          <span><strong class="text-foreground">Place:</strong> {city}</span>
          <span><strong class="text-foreground">Lagna:</strong> {lagnaEnglish}</span>
          {moonSign && <span><strong class="text-foreground">Moon Sign:</strong> {moonSign}</span>}
        </div>
        <p class="text-[11px] text-muted-foreground/70 mt-2">
          Birth time accuracy: {timeAccuracyLabel} ({celeb.timeSource}) · Data sourced from publicly available records
        </p>
      </div>
      <div class="flex items-center gap-2 shrink-0">
        <ShareButton client:visible userName={name} />
        <a href="/kundli" class="inline-flex items-center gap-1 text-muted-foreground hover:text-foreground text-xs font-semibold px-3 py-2 rounded-lg border border-border hover:bg-accent transition-colors">
          <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg>
          Your Chart
        </a>
      </div>
    </div>
  </div>

  <!-- Section quick-jump -->
  <nav id="section-nav" class="sticky top-0 z-30 mb-6 -mx-4 md:-mx-6 lg:-mx-8 px-4 md:px-6 lg:px-8 py-3 bg-background/80 backdrop-blur-lg border-b border-border" aria-label="Report sections">
    <div class="flex flex-wrap gap-2 md:flex-nowrap">
      {reportTabs.map((tab, i) => (
        <button
          type="button"
          data-section-pill={tab.id}
          class={`section-pill px-4 py-2 rounded-full text-[13px] font-semibold transition-all duration-200 ${i === 0 ? 'bg-primary text-primary-foreground' : 'bg-secondary text-secondary-foreground hover:bg-primary/80 hover:text-primary-foreground'}`}
        >
          {tab.label}
        </button>
      ))}
    </div>
  </nav>
  <script is:inline>
  (function() {
    var pills = document.querySelectorAll('[data-section-pill]');
    var activeClass = 'bg-primary text-primary-foreground';
    var inactiveClass = 'bg-secondary text-secondary-foreground hover:bg-primary/80 hover:text-primary-foreground';
    function setActive(id) {
      pills.forEach(function(p) {
        var isActive = p.getAttribute('data-section-pill') === id;
        activeClass.split(' ').forEach(function(c) { p.classList.toggle(c, isActive); });
        inactiveClass.split(' ').forEach(function(c) { p.classList.toggle(c, !isActive); });
      });
    }
    pills.forEach(function(btn) {
      btn.addEventListener('click', function() {
        var id = btn.getAttribute('data-section-pill');
        var el = document.getElementById(id);
        if (el) { setActive(id); el.scrollIntoView({ behavior: 'smooth', block: 'start' }); }
      });
    });
    var sectionIds = [];
    pills.forEach(function(p) { sectionIds.push(p.getAttribute('data-section-pill')); });
    var observer = new IntersectionObserver(function(entries) {
      entries.forEach(function(entry) { if (entry.isIntersecting) setActive(entry.target.id); });
    }, { rootMargin: '-80px 0px -60% 0px', threshold: 0 });
    sectionIds.forEach(function(id) { var el = document.getElementById(id); if (el) observer.observe(el); });
  })();
  </script>

  <!-- Overview: Chart + Panchang/Dasha -->
  <section id="overview" class="scroll-mt-16">
    <div class="grid grid-cols-1 lg:grid-cols-[1fr_380px] gap-6 md:gap-8">
      <div class="rounded-xl border border-border bg-card p-5 md:p-6">
        <NorthIndianChart client:visible chartData={chartData} large={true} showEnglishSigns={true} />
      </div>

      <div class="flex flex-col gap-5 md:gap-6">
        <!-- Panchang -->
        <div class="rounded-xl border border-border bg-card p-5">
          <h2 class="text-base font-bold text-foreground tracking-tight mb-4">Panchang <span class="text-muted-foreground font-normal text-xs">(Five Limbs)</span></h2>
          <dl class="space-y-0">
            {[
              { k: 'Tithi', v: panchangData.tithi },
              { k: 'Nakshatra', v: `${panchangData.nakshatra}${panchangData.nakshatraPada ? ` (${panchangData.nakshatraPada})` : ''}` },
              { k: 'Yoga', v: panchangData.yoga },
              { k: 'Karana', v: panchangData.karana },
              { k: 'Vara', v: panchangData.vara },
            ].map((item, i) => (
              <div class={`flex justify-between items-center py-2.5 ${i < 4 ? 'border-b border-border' : ''}`}>
                <dt class="text-xs font-semibold text-muted-foreground uppercase tracking-wider">{item.k}</dt>
                <dd class="text-sm font-bold text-foreground">{item.v}</dd>
              </div>
            ))}
          </dl>
        </div>

        <!-- Dasha snapshot -->
        <div class="rounded-xl border border-border bg-card p-5">
          <h2 class="text-base font-bold text-foreground tracking-tight mb-4">Current Dasha</h2>
          <div class="space-y-2">
            {dashaData.periods.map((period, idx) => {
              const col = DASHA_COLORS[period.planet] ?? '#334155';
              const isFirst = idx === 0;
              return (
                <div class="relative overflow-hidden rounded-lg" style={`background:${col}08`}>
                  <div class="absolute left-0 top-0 bottom-0 w-1 rounded-full" style={`background:${col}`} />
                  <div class="pl-4 pr-3 py-2.5 flex items-center gap-3">
                    <div class="flex-1 min-w-0">
                      <p class="text-[10px] font-bold uppercase tracking-widest text-muted-foreground leading-none mb-0.5">{period.label}</p>
                      <p class={`font-extrabold tracking-tight leading-tight inline-flex items-center gap-1.5 ${isFirst ? 'text-xl' : 'text-base'}`} style={`color:${col}`}>
                        <span set:html={planetIconSvg(period.planet, isFirst ? 20 : 16)} />{period.planet}
                      </p>
                    </div>
                    <div class="text-right shrink-0">
                      <p class={`font-bold text-foreground ${isFirst ? 'text-base' : 'text-sm'}`}>{period.duration}</p>
                      <p class="text-[11px] font-semibold text-muted-foreground mt-0.5">{period.start} – {period.end}</p>
                    </div>
                  </div>
                </div>
              );
            })}
          </div>
          <div class="mt-3 flex items-center justify-center gap-1">
            {dashaData.periods.map((p, i) => (
              <Fragment>
                {i > 0 && (
                  <svg class="w-3.5 h-3.5 text-muted-foreground/40 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M9 5l7 7-7 7" /></svg>
                )}
                <span class="text-xs font-bold inline-flex items-center gap-0.5" style={`color:${DASHA_COLORS[p.planet] ?? '#334155'}`}><span set:html={planetIconSvg(p.planet, 12)} />{p.planet}</span>
              </Fragment>
            ))}
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- 1. Planets -->
  <section id="planets" class="pt-2 scroll-mt-16">
    <h2 class="text-lg font-bold text-foreground tracking-tight mb-4">{name}'s Planet Positions</h2>
    <div class="hidden md:block rounded-xl border border-border bg-card overflow-hidden">
      <table class="w-full text-sm">
        <thead>
          <tr class="bg-secondary border-b border-border">
            <th class="text-left px-5 py-3 text-xs font-bold text-muted-foreground uppercase tracking-wider">Planet</th>
            <th class="text-left px-5 py-3 text-xs font-bold text-muted-foreground uppercase tracking-wider">Sign</th>
            <th class="text-center px-5 py-3 text-xs font-bold text-muted-foreground uppercase tracking-wider">Degree</th>
            <th class="text-center px-5 py-3 text-xs font-bold text-muted-foreground uppercase tracking-wider">House</th>
            <th class="text-center px-5 py-3 text-xs font-bold text-muted-foreground uppercase tracking-wider">Status</th>
          </tr>
        </thead>
        <tbody>
          {planetRows.map((p, i) => (
            <tr class={i < planetRows.length - 1 ? 'border-b border-border/50' : ''}>
              <td class="px-5 py-3">
                <span class="font-bold inline-flex items-center gap-1.5" style={`color:${DASHA_COLORS[p.graha] ?? '#334155'}`}>
                  <span set:html={planetIconSvg(p.graha, 16)} />{p.graha}
                </span>
              </td>
              <td class="px-5 py-3">
                <span class="font-semibold text-foreground">{p.sign}</span>
                <span class="text-muted-foreground text-xs font-medium ml-1.5">({p.signSanskrit})</span>
              </td>
              <td class="px-5 py-3 text-center font-mono font-semibold text-foreground">{String(p.degree).padStart(2, '0')}°</td>
              <td class="px-5 py-3 text-center font-bold text-muted-foreground">{p.house}</td>
              <td class="px-5 py-3 text-center">
                {p.retrograde
                  ? <span class="inline-flex items-center gap-1 text-xs font-bold text-red-500 bg-red-50 px-2 py-0.5 rounded-full">R</span>
                  : <span class="text-xs font-semibold text-muted-foreground">Direct</span>}
              </td>
            </tr>
          ))}
        </tbody>
      </table>
    </div>
    <div class="md:hidden space-y-2.5">
      {planetRows.map((p) => (
        <div class="rounded-xl border border-border bg-card px-4 py-3 flex items-center gap-3">
          <span class="shrink-0" style={`color:${DASHA_COLORS[p.graha] ?? '#334155'}`} set:html={planetIconSvg(p.graha, 20)} />
          <div class="flex-1 min-w-0">
            <p class="font-bold text-sm" style={`color:${DASHA_COLORS[p.graha] ?? '#334155'}`}>
              {p.graha}
              {p.retrograde && <span class="ml-1.5 text-[10px] font-bold text-red-500 bg-red-50 px-1.5 py-0.5 rounded-full align-middle">R</span>}
            </p>
            <p class="text-xs text-muted-foreground mt-0.5">{p.sign} ({p.signSanskrit})</p>
          </div>
          <div class="text-right shrink-0">
            <p class="text-sm font-mono font-bold text-foreground">{String(p.degree).padStart(2, '0')}°</p>
            <p class="text-xs font-semibold text-muted-foreground">House {p.house}</p>
          </div>
        </div>
      ))}
    </div>
  </section>

  <!-- 2. Dasha Timeline -->
  <section id="dasha" class="pt-8 scroll-mt-16">
    <h2 class="text-lg font-bold text-foreground tracking-tight mb-1">Vimshottari Dasha Timeline</h2>
    <p class="text-xs font-semibold text-muted-foreground mb-4">Click any period to drill into Antardasha and Pratyantardasha sub-periods</p>
    <DashaTimeline client:visible mahas={mahasTimeline} colors={DASHA_COLORS} />
  </section>

  <!-- 3. Yogas -->
  <section id="yogas" class="pt-8 scroll-mt-16">
    <h2 class="text-lg font-bold text-foreground tracking-tight mb-1">Yogas <span class="text-muted-foreground font-normal text-xs">(Planetary Combinations)</span></h2>
    <p class="text-xs font-semibold text-muted-foreground mb-5">{yogaResults.length} yoga{yogaResults.length !== 1 ? 's' : ''} found in {name}'s chart</p>

    {yogaResults.length === 0 ? (
      <div class="rounded-xl border border-dashed border-border bg-secondary/50 p-6 text-center">
        <p class="text-sm font-bold text-foreground">No prominent yogas detected</p>
        <p class="text-xs text-muted-foreground mt-1">This is rare — most charts have at least one yoga</p>
      </div>
    ) : (
      <div class="space-y-8">
        {categoryOrder.map(cat => {
          const yogas = yogasByCategory.get(cat);
          if (!yogas || yogas.length === 0) return null;
          const isDosha = cat === 'dosha';
          return (
            <div>
              <div class="mb-3">
                <h3 class={`text-sm font-bold uppercase tracking-wide ${isDosha ? 'text-red-600' : 'text-foreground'}`}>{YOGA_CATEGORY_LABELS[cat]}</h3>
                <p class="text-xs text-muted-foreground mt-0.5">{yogaCatDesc[cat]}</p>
              </div>
              <div class="space-y-3">
                {yogas.map(yoga => {
                  const sColor = isDosha
                    ? (yoga.strength === 'strong' ? '#dc2626' : yoga.strength === 'moderate' ? '#f97316' : '#64748b')
                    : (yoga.strength === 'strong' ? '#059669' : yoga.strength === 'moderate' ? '#3b82f6' : '#64748b');
                  const sLabel = isDosha
                    ? (yoga.strength === 'strong' ? 'Significant' : yoga.strength === 'moderate' ? 'Present' : 'Mild')
                    : (yoga.strength === 'strong' ? 'Very Powerful' : yoga.strength === 'moderate' ? 'Active' : 'Mild');
                  const bars = yoga.strength === 'strong' ? 3 : yoga.strength === 'moderate' ? 2 : 1;
                  return (
                  <div class={`rounded-xl border overflow-hidden ${isDosha ? 'border-red-200/60 bg-red-50/30' : 'border-border bg-card'}`}>
                    <div class="px-4 py-4">
                      <div class="flex-1 min-w-0">
                        <div class="flex items-center gap-2 flex-wrap">
                          <span class={`text-[15px] font-bold tracking-tight ${isDosha ? 'text-red-700' : 'text-foreground'}`}>{yoga.name}</span>
                          {yoga.sanskrit && <span class="text-sm text-muted-foreground font-medium">{yoga.sanskrit}</span>}
                          <span class="flex items-center gap-1.5 ml-auto sm:ml-0">
                            <span class="flex items-end gap-[3px]" title={sLabel}>
                              {[1, 2, 3].map(n => (
                                <span class={`w-[4px] rounded-sm ${n === 1 ? 'h-[8px]' : n === 2 ? 'h-[12px]' : 'h-[16px]'}`}
                                  style={`background:${n <= bars ? sColor : '#cbd5e1'}`} />
                              ))}
                            </span>
                            <span class="text-xs font-bold" style={`color:${sColor}`}>{sLabel}</span>
                          </span>
                        </div>
                        <p class="text-sm text-muted-foreground mt-1.5 font-medium">{yoga.description}</p>
                        <p class="text-sm text-foreground mt-1.5 leading-relaxed">{yoga.effect}</p>
                        <div class="flex items-center gap-2 mt-3 flex-wrap">
                          {yoga.planets.map(planet => (
                            <span class="text-xs font-bold px-2.5 py-1 rounded-md bg-secondary border border-border inline-flex items-center gap-1" style={`color:${DASHA_COLORS[planet] ?? '#334155'}`}>
                              <span set:html={planetIconSvg(planet, 14)} />{planet}
                            </span>
                          ))}
                          {yoga.houses.length > 0 && (
                            <span class="text-xs font-bold text-muted-foreground">H{[...new Set(yoga.houses)].join(', H')}</span>
                          )}
                        </div>
                        {yoga.detail && (
                          <details class="mt-3 group">
                            <summary class={`text-sm font-semibold cursor-pointer select-none list-none flex items-center gap-1.5 ${isDosha ? 'text-red-500 hover:text-red-700' : 'text-primary hover:text-primary/80'} transition-colors`}>
                              <svg class="w-4 h-4 shrink-0 transition-transform group-open:rotate-90" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg>
                              Learn more about this yoga
                            </summary>
                            <div class={`mt-2.5 pl-5 border-l-2 ${isDosha ? 'border-red-200' : 'border-border'}`}>
                              <p class="text-sm text-foreground leading-relaxed">{yoga.detail}</p>
                            </div>
                          </details>
                        )}
                      </div>
                    </div>
                  </div>
                  );
                })}
              </div>
            </div>
          );
        })}
      </div>
    )}
  </section>

  <!-- 4. Transits -->
  <section id="transits" class="pt-8 scroll-mt-16">
    <h2 class="text-lg font-bold text-foreground tracking-tight mb-1">Transits <span class="text-muted-foreground font-normal text-sm">(Gochar)</span></h2>
    <p class="text-sm text-muted-foreground mb-5">Where planets are today and how they affect {name}'s natal houses</p>
    <TransitSection client:visible initialTransit={transitResult} natalLagna={chartData.lagna} />
  </section>

  <!-- 5. Divisional Charts -->
  <section id="divisional" class="pt-8 pb-4 scroll-mt-16">
    <h2 class="text-lg font-bold text-foreground tracking-tight mb-1">Divisional Charts <span class="text-muted-foreground font-normal text-sm">(Varga)</span></h2>
    <p class="text-sm text-muted-foreground mb-4">Each chart zooms into a specific life area — {vargaCharts.length} charts computed</p>

    <div class="sticky top-[52px] z-20 -mx-4 md:-mx-6 lg:-mx-8 px-4 md:px-6 lg:px-8 py-2.5 bg-background/90 backdrop-blur-lg border-b border-border mb-5">
      <div class="flex flex-wrap gap-1.5">
        {vargaCharts.map(vc => {
          const shortPurpose = vc.def.purpose.split('&')[0].split(',')[0].trim();
          return (
            <button type="button" data-varga-pill={vc.def.id}
              class="varga-pill px-3 py-1.5 rounded-full text-xs font-bold transition-all duration-200 bg-secondary text-secondary-foreground hover:bg-primary/80 hover:text-primary-foreground">
              {vc.def.id} <span class="font-medium ml-0.5">{shortPurpose}</span>
            </button>
          );
        })}
      </div>
    </div>
    <script is:inline>
    (function() {
      var pills = document.querySelectorAll('[data-varga-pill]');
      var activeClass = 'bg-primary text-primary-foreground';
      var inactiveClass = 'bg-secondary text-secondary-foreground hover:bg-primary/80 hover:text-primary-foreground';
      function setVargaActive(id) {
        pills.forEach(function(p) {
          var isActive = p.getAttribute('data-varga-pill') === id;
          activeClass.split(' ').forEach(function(c) { p.classList.toggle(c, isActive); });
          inactiveClass.split(' ').forEach(function(c) { p.classList.toggle(c, !isActive); });
        });
      }
      pills.forEach(function(btn) {
        btn.addEventListener('click', function() {
          var id = btn.getAttribute('data-varga-pill');
          var el = document.getElementById('varga-' + id);
          if (!el) return;
          setVargaActive(id);
          if (!el.open) el.open = true;
          setTimeout(function() { el.scrollIntoView({ behavior: 'smooth', block: 'start' }); }, 50);
        });
      });
    })();
    </script>

    <div class="space-y-4">
      {vargaCharts.map(vc => {
        const vcChartData = vargaToChartData(vc);
        return (
        <details id={`varga-${vc.def.id}`} class="rounded-xl border border-border overflow-hidden scroll-mt-[120px] group">
          <summary class="px-5 py-5 cursor-pointer select-none list-none flex items-start gap-3 bg-card">
            <div class="flex-1 min-w-0">
              <div class="flex items-center gap-2.5 flex-wrap">
                <span class="text-sm font-bold px-2.5 py-1 rounded-lg bg-secondary text-secondary-foreground">{vc.def.id}</span>
                <span class="text-lg font-bold tracking-tight text-foreground">{vc.def.purpose}</span>
              </div>
              <p class="text-sm text-muted-foreground mt-1">{vc.def.name} {vc.def.sanskrit} · Lagna {RASHI_ENGLISH[vc.lagna] ?? vc.lagna}</p>
              <p class="text-[15px] text-muted-foreground mt-2 leading-relaxed">{vc.def.description}</p>
            </div>
            <svg class="w-5 h-5 text-muted-foreground shrink-0 mt-1.5 transition-transform group-open:rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
          </summary>
          <div class="border-t border-border bg-card">
            <div class="px-5 py-4">
              <div class="mx-auto max-w-md">
                <NorthIndianChart client:visible chartData={vcChartData} showEnglishSigns={true} />
              </div>
            </div>
            <div class="px-5 pb-5">
              <div class="hidden md:block rounded-xl border border-border overflow-hidden">
                <table class="w-full text-sm">
                  <thead>
                    <tr class="bg-secondary border-b border-border">
                      <th class="text-left px-5 py-2.5 text-xs font-bold text-muted-foreground uppercase tracking-wider">Planet</th>
                      <th class="text-left px-5 py-2.5 text-xs font-bold text-muted-foreground uppercase tracking-wider">Sign</th>
                      <th class="text-center px-5 py-2.5 text-xs font-bold text-muted-foreground uppercase tracking-wider">Degree</th>
                      <th class="text-center px-5 py-2.5 text-xs font-bold text-muted-foreground uppercase tracking-wider">House</th>
                    </tr>
                  </thead>
                  <tbody>
                    {vc.planets.sort((a, b) => PLANET_ORDER.indexOf(a.graha) - PLANET_ORDER.indexOf(b.graha)).map((p, i) => (
                      <tr class={i < vc.planets.length - 1 ? 'border-b border-border/50' : ''}>
                        <td class="px-5 py-2.5">
                          <span class="font-bold inline-flex items-center gap-1.5" style={`color:${DASHA_COLORS[p.graha] ?? '#334155'}`}>
                            <span set:html={planetIconSvg(p.graha, 16)} />{p.graha}
                            {p.retrograde && <span class="text-[10px] font-bold text-red-500 bg-red-50 px-1.5 py-0.5 rounded-full">R</span>}
                          </span>
                        </td>
                        <td class="px-5 py-2.5 font-semibold text-foreground">{RASHI_ENGLISH[p.rashi] ?? p.rashi}</td>
                        <td class="px-5 py-2.5 text-center font-mono font-semibold text-foreground">{String(p.degree).padStart(2, '0')}°</td>
                        <td class="px-5 py-2.5 text-center font-bold text-muted-foreground">{p.house}</td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
              <div class="md:hidden grid grid-cols-3 gap-2">
                {vc.planets.sort((a, b) => PLANET_ORDER.indexOf(a.graha) - PLANET_ORDER.indexOf(b.graha)).map(p => (
                  <div class="rounded-lg bg-secondary border border-border px-3 py-2.5 text-center">
                    <p class="text-xs font-bold inline-flex items-center justify-center gap-1" style={`color:${DASHA_COLORS[p.graha] ?? '#334155'}`}>
                      <span set:html={planetIconSvg(p.graha, 13)} />{p.graha}{p.retrograde ? <span class="text-red-500 ml-0.5">R</span> : ''}
                    </p>
                    <p class="text-xs text-muted-foreground font-semibold mt-0.5">{RASHI_ENGLISH[p.rashi] ?? p.rashi}</p>
                    <p class="text-[11px] text-muted-foreground font-medium">H{p.house} · {p.degree}°</p>
                  </div>
                ))}
              </div>
            </div>
          </div>
        </details>
        );
      })}
    </div>
  </section>

  <!-- Bottom CTA -->
  <div class="mt-12 mb-4 rounded-xl border border-border bg-card px-5 py-6 text-center">
    <p class="text-foreground font-semibold text-base mb-1">Want to see your own chart?</p>
    <p class="text-muted-foreground text-sm mb-5">Generate your free Vedic birth chart with the same level of detail</p>
    <div class="flex flex-wrap items-center justify-center gap-3">
      <a href="/kundli" class="bg-primary text-primary-foreground font-semibold text-sm px-6 py-2.5 rounded-lg hover:bg-primary/90 transition-colors">
        Generate My Kundli
      </a>
      <a href="/kundli/celebrity" class="text-muted-foreground hover:text-foreground text-sm font-semibold px-4 py-2 rounded-lg hover:bg-accent transition-colors">
        Browse Celebrity Charts
      </a>
    </div>
  </div>
</ReportLayout>
