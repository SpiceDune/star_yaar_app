---
import { computeKundli } from '../../lib/compute-kundli';
import { getPanchangByDate } from '../../lib/db/panchang';
import { saveKundliChart } from '../../lib/db/kundli-charts';

const SRK = {
  name: 'Shah Rukh Khan',
  dob: '1965-11-02',
  time: '02:30',
  city: 'New Delhi, India',
  lat: 28.6353,
  lon: 77.225,
  timezone: 'Asia/Kolkata',
};

let redirectUrl = '/kundli';

try {
  const computed = await computeKundli({
    dob: SRK.dob,
    time: SRK.time,
    lat: SRK.lat,
    lon: SRK.lon,
    timezone: SRK.timezone,
  });

  if (computed) {
    const panchang = await getPanchangByDate(SRK.dob);
    const id = await saveKundliChart({
      name: SRK.name,
      dob: SRK.dob,
      time_of_birth: SRK.time,
      city: SRK.city,
      latitude: SRK.lat,
      longitude: SRK.lon,
      timezone: SRK.timezone,
      chart_data: computed.chartData,
      dasha_data: computed.dasha,
      panchang_data: panchang,
    });

    if (id) {
      redirectUrl = `/kundli/${id}`;
    }
  }
} catch (err) {
  console.error('[sample] failed to generate SRK chart:', err);
}

return Astro.redirect(redirectUrl, 302);
---
