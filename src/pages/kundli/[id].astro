---
import ReportLayout from '../../layouts/ReportLayout.astro';
import NorthIndianChart from '../../components/charts/NorthIndianChart';
import DashaTimeline from '../../components/report/DashaTimeline';
import { getKundliChart } from '../../lib/db/kundli-charts';
import { mockPanchang } from '../../lib/mock-data';
import { RASHI_ENGLISH, GRAHA_ICON_SVG, planetIconSvg } from '../../lib/constants';
import { computeYogas, YOGA_CATEGORY_LABELS } from '../../lib/yoga-engine';
import type { YogaCategory } from '../../lib/yoga-engine';
import { computeTransits } from '../../lib/compute-transits';
import TransitSection from '../../components/report/TransitSection';
import DownloadPdfButton from '../../components/report/DownloadPdfButton';
import ShareButton from '../../components/report/ShareButton';
import { computeAllVargaCharts, VARGA_DEFS } from '../../lib/divisional-charts';
import type { ChartData, Panchang as PanchangType, GrahaId, RashiId } from '../../lib/types';

const { id } = Astro.params;
const row = id ? await getKundliChart(id) : null;

if (!row) {
  return Astro.redirect('/');
}

const MONTHS = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
function formatDOB(iso: string | undefined): string {
  if (!iso) return '';
  const [y, m, d] = iso.split('-').map(Number);
  if (!d || !m) return iso;
  return `${d} ${MONTHS[m - 1]} ${y}`;
}

const name = row.name;
const dobRaw = row.dob;
const timeOfBirth = row.time_of_birth || '10:30 AM';
const city = row.city || '';
const formattedDOB = formatDOB(dobRaw) || dobRaw;

const panchangData: PanchangType = row.panchang_data ?? mockPanchang;
const chartData: ChartData = row.chart_data;
const dashaData = row.dasha_data;

const chartId = row.id;

const DASHA_COLORS: Record<string, string> = {
  Sun: '#ea580c', Moon: '#7c3aed', Mars: '#e11d48', Mercury: '#059669',
  Jupiter: '#d97706', Venus: '#ec4899', Saturn: '#475569',
  Rahu: '#2563eb', Ketu: '#6366f1',
};

// ── Derived data for sections ──

interface PlanetRow {
  graha: GrahaId;
  sign: string;
  signSanskrit: string;
  degree: number;
  house: number;
  retrograde: boolean;
}
const planetRows: PlanetRow[] = [];
const PLANET_ORDER: GrahaId[] = ['Sun','Moon','Mars','Mercury','Jupiter','Venus','Saturn','Rahu','Ketu'];
for (let h = 1; h <= 12; h++) {
  const house = chartData.houses[h];
  if (!house?.planets) continue;
  for (const p of house.planets) {
    planetRows.push({
      graha: p.graha,
      sign: RASHI_ENGLISH[house.rashi] ?? String(house.rashi),
      signSanskrit: String(house.rashi),
      degree: p.degree,
      house: h,
      retrograde: p.retrograde ?? false,
    });
  }
}
planetRows.sort((a, b) => PLANET_ORDER.indexOf(a.graha) - PLANET_ORDER.indexOf(b.graha));

// Vimshottari Dasha full timeline computation
const VIMSHOTTARI_SEQ = ['Ketu','Venus','Sun','Moon','Mars','Rahu','Jupiter','Saturn','Mercury'];
const VIMSHOTTARI_YEARS: Record<string, number> = {
  Ketu: 7, Venus: 20, Sun: 6, Moon: 10, Mars: 7, Rahu: 18, Jupiter: 16, Saturn: 19, Mercury: 17,
};
const _MS_YEAR = 365.25 * 24 * 3600 * 1000;

function _parseDate(s: string): number {
  const parts = s.split(' ');
  if (parts.length !== 3) return Date.now();
  return new Date(Number(parts[2]), MONTHS.indexOf(parts[1]), Number(parts[0])).getTime();
}
function _fmtDate(ms: number): string {
  const dt = new Date(ms);
  return `${dt.getDate()} ${MONTHS[dt.getMonth()]} ${dt.getFullYear()}`;
}
function _fmtDur(y: number): string {
  if (y >= 1) return `${y.toFixed(1)}y`;
  const m = y * 12;
  if (m >= 1) return `${Math.round(m)}m`;
  return `${Math.round(y * 365)}d`;
}

const _curMaha = dashaData.periods[0]?.planet ?? '';
const _curAntar = dashaData.periods[1]?.planet ?? '';
const _curMahaStartMs = _parseDate(dashaData.periods[0]?.start ?? '');
const _curMahaEndMs = _parseDate(dashaData.periods[0]?.end ?? '');
const _curMahaIdx = VIMSHOTTARI_SEQ.indexOf(_curMaha);
const _nowMs = Date.now();

const _allMaha: { planet: string; startMs: number; endMs: number; years: number }[] = [];
const _back: typeof _allMaha = [];
let _bc = _curMahaStartMs;
for (let i = 1; i <= 8; i++) {
  const idx = ((_curMahaIdx - i) % 9 + 9) % 9;
  const p = VIMSHOTTARI_SEQ[idx];
  const yr = VIMSHOTTARI_YEARS[p];
  const e = _bc; const s = e - yr * _MS_YEAR;
  _back.unshift({ planet: p, startMs: s, endMs: e, years: yr });
  _bc = s;
}
_allMaha.push(..._back);
_allMaha.push({ planet: _curMaha, startMs: _curMahaStartMs, endMs: _curMahaEndMs, years: VIMSHOTTARI_YEARS[_curMaha] ?? 0 });
let _fc = _curMahaEndMs;
for (let i = 1; i <= 8; i++) {
  const idx = (_curMahaIdx + i) % 9;
  const p = VIMSHOTTARI_SEQ[idx];
  const yr = VIMSHOTTARI_YEARS[p];
  const s = _fc; const e = s + yr * _MS_YEAR;
  _allMaha.push({ planet: p, startMs: s, endMs: e, years: yr });
  _fc = e;
}

const [_by, _bm, _bd] = dobRaw.split('-').map(Number);
const _birthMs = new Date(_by, _bm - 1, _bd).getTime();
let _fi = _allMaha.findIndex(e => e.startMs <= _birthMs && e.endMs > _birthMs);
if (_fi < 0) _fi = Math.max(0, _allMaha.length - 9);
const _lifeMahasRaw = _allMaha.slice(_fi, _fi + 9);
const _lifeMahas = _lifeMahasRaw.map((m, idx) => {
  if (idx === 0 && m.startMs < _birthMs) {
    const remainingYears = (m.endMs - _birthMs) / _MS_YEAR;
    return { ...m, startMs: _birthMs, years: Math.round(remainingYears * 10) / 10 };
  }
  return m;
});

import type { MahaEntry, AntarEntry } from '../../components/report/DashaTimeline';
const mahasTimeline: MahaEntry[] = _lifeMahas.map((maha, mi) => {
  const mIdx = VIMSHOTTARI_SEQ.indexOf(maha.planet);
  const fullYears = VIMSHOTTARI_YEARS[maha.planet] ?? 0;
  const origRaw = _lifeMahasRaw[mi];
  const origStart = origRaw.startMs;
  const isFirstClipped = mi === 0 && origStart < _birthMs;

  const allAntars: AntarEntry[] = [];
  let ac = origStart;
  for (let i = 0; i < 9; i++) {
    const idx = (mIdx + i) % 9;
    const p = VIMSHOTTARI_SEQ[idx];
    const durY = (fullYears * (VIMSHOTTARI_YEARS[p] ?? 0)) / 120;
    const durMs = durY * _MS_YEAR;
    const s = ac; const e = ac + durMs;
    allAntars.push({
      planet: p,
      duration: _fmtDur(durY),
      startMs: s,
      endMs: e,
      start: _fmtDate(s),
      end: _fmtDate(e),
      isCurrent: maha.planet === _curMaha && p === _curAntar && s <= _nowMs && e > _nowMs,
      mahaYears: fullYears,
    });
    ac = e;
  }

  let antars = allAntars;
  if (isFirstClipped) {
    antars = allAntars
      .filter(a => a.endMs > _birthMs)
      .map((a, ai) => {
        if (ai === 0 && a.startMs < _birthMs) {
          const remainY = (a.endMs - _birthMs) / _MS_YEAR;
          return { ...a, startMs: _birthMs, start: _fmtDate(_birthMs), duration: _fmtDur(remainY) };
        }
        return a;
      });
  }

  return {
    planet: maha.planet,
    years: maha.years,
    start: _fmtDate(maha.startMs),
    end: _fmtDate(maha.endMs),
    isCurrent: maha.planet === _curMaha,
    antars,
  };
});

// Compute Yogas
const yogaResults = computeYogas(chartData);
const yogasByCategory = new Map<YogaCategory, typeof yogaResults>();
for (const y of yogaResults) {
  const list = yogasByCategory.get(y.category) ?? [];
  list.push(y);
  yogasByCategory.set(y.category, list);
}
const categoryOrder: YogaCategory[] = ['mahapurusha', 'raja', 'dhana', 'lunar', 'special', 'dosha'];

const yogaCatDesc: Record<string, string> = {
  mahapurusha: 'Formed when Mars, Mercury, Jupiter, Venus, or Saturn occupies a Kendra in own/exalted sign',
  raja: 'Kendra and Trikona lords connecting — the hallmark of power and authority',
  dhana: 'Planetary combinations indicating wealth accumulation and financial prosperity',
  lunar: 'Yogas formed based on the Moon\'s relationship with surrounding planets',
  special: 'Rare and notable combinations with unique effects on the native\'s life',
  dosha: 'Challenging planetary placements that may require awareness and remedies',
};

// Compute Transits
const transitResult = await computeTransits(chartData);

// Compute Divisional Charts
const vargaCharts = computeAllVargaCharts(chartData);

// Convert VargaChartResult → ChartData for the NorthIndianChart component
import type { VargaChartResult } from '../../lib/divisional-charts';
const RASHI_ORDER_FULL: RashiId[] = ['Mesha','Vrishabha','Mithuna','Karka','Simha','Kanya','Tula','Vrishchika','Dhanu','Makara','Kumbha','Meena'];
function vargaToChartData(vc: VargaChartResult): ChartData {
  const lagnaIdx = RASHI_ORDER_FULL.indexOf(vc.lagna);
  const houses: ChartData['houses'] = {} as ChartData['houses'];
  for (let i = 1; i <= 12; i++) {
    const rashiIdx = (lagnaIdx + i - 1) % 12;
    houses[i] = { rashi: RASHI_ORDER_FULL[rashiIdx], planets: [] };
  }
  for (const p of vc.planets) {
    if (houses[p.house]) {
      houses[p.house].planets.push({ graha: p.graha, degree: p.degree, retrograde: p.retrograde });
    }
  }
  return { lagna: vc.lagna, houses, chartName: vc.def.id, chartType: vc.def.name };
}

const reportTabs = [
  { id: 'planets', label: 'Planets' },
  { id: 'dasha', label: 'Dasha Timeline' },
  { id: 'yogas', label: 'Yogas' },
  { id: 'transits', label: 'Transits' },
  { id: 'divisional', label: 'Divisional Charts' },
];

---

<ReportLayout title={`${name}'s Birth Chart | StarYaar`} wide={true}>
  <!-- Status banner -->
  <div class="bg-card border border-border rounded-xl px-4 md:px-5 py-4 mb-6 md:mb-8">
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 rounded-lg bg-primary/10 flex items-center justify-center shrink-0">
          <svg class="w-5 h-5 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
        </div>
        <div>
          <p class="text-foreground font-semibold text-[15px]">{name}'s Birth Chart</p>
          <p class="text-muted-foreground text-xs mt-0.5">{formattedDOB}{city ? ` · ${city}` : ''}</p>
        </div>
      </div>
      <div class="flex items-center gap-2">
        <ShareButton client:visible chartId={chartId} userName={name} />
        <DownloadPdfButton client:visible userName={name} />
        <a href="/kundli" class="inline-flex items-center gap-1 text-muted-foreground hover:text-foreground text-xs font-semibold px-3 py-2 rounded-lg border border-border hover:bg-accent transition-colors">
          <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg>
          New
        </a>
      </div>
    </div>
  </div>

  <!-- Main grid: Chart + Panchang/Dasha -->
  <section class="grid grid-cols-1 lg:grid-cols-[1fr_380px] gap-6 md:gap-8">
    <div class="rounded-xl border border-border bg-card p-5 md:p-6">
      <NorthIndianChart client:visible chartData={chartData} large={true} showEnglishSigns={true} />
    </div>

    <div class="flex flex-col gap-5 md:gap-6">
      <!-- Panchang -->
      <div class="rounded-xl border border-border bg-card p-5">
        <h2 class="text-base font-bold text-slate-800 tracking-tight mb-4">Panchang <span class="text-slate-500 font-normal text-xs">(Five Limbs)</span></h2>
        <dl class="space-y-0">
          {[
            { k: 'Tithi', v: panchangData.tithi },
            { k: 'Nakshatra', v: `${panchangData.nakshatra}${panchangData.nakshatraPada ? ` (${panchangData.nakshatraPada})` : ''}` },
            { k: 'Yoga', v: panchangData.yoga },
            { k: 'Karana', v: panchangData.karana },
            { k: 'Vara', v: panchangData.vara },
          ].map((item, i) => (
            <div class={`flex justify-between items-center py-2.5 ${i < 4 ? 'border-b border-slate-100' : ''}`}>
              <dt class="text-xs font-semibold text-slate-500 uppercase tracking-wider">{item.k}</dt>
              <dd class="text-sm font-bold text-slate-700">{item.v}</dd>
            </div>
          ))}
        </dl>
      </div>

      <!-- Dasha -->
      <div class="rounded-xl border border-slate-200/80 bg-white p-5">
        <h2 class="text-base font-bold text-slate-800 tracking-tight mb-4">Current Dasha</h2>

        <div class="space-y-2">
          {dashaData.periods.map((period, idx) => {
            const col = DASHA_COLORS[period.planet] ?? '#334155';
            const isFirst = idx === 0;
            return (
              <div class="relative overflow-hidden rounded-lg" style={`background:${col}08`}>
                <div class="absolute left-0 top-0 bottom-0 w-1 rounded-full" style={`background:${col}`} />
                <div class="pl-4 pr-3 py-2.5 flex items-center gap-3">
                  <div class="flex-1 min-w-0">
                    <p class="text-[10px] font-bold uppercase tracking-widest text-slate-400 leading-none mb-0.5">{period.label}</p>
                    <p class={`font-extrabold tracking-tight leading-tight inline-flex items-center gap-1.5 ${isFirst ? 'text-xl' : 'text-base'}`} style={`color:${col}`}>
                      <span set:html={planetIconSvg(period.planet, isFirst ? 20 : 16)} />{period.planet}
                    </p>
                  </div>
                  <div class="text-right shrink-0">
                    <p class={`font-bold text-slate-700 ${isFirst ? 'text-base' : 'text-sm'}`}>{period.duration}</p>
                    <p class="text-[11px] font-semibold text-slate-500 mt-0.5">{period.start} – {period.end}</p>
                  </div>
                </div>
              </div>
            );
          })}
        </div>

        <div class="mt-3 flex items-center justify-center gap-1">
          {dashaData.periods.map((p, i) => (
            <Fragment>
              {i > 0 && (
                <svg class="w-3.5 h-3.5 text-slate-300 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M9 5l7 7-7 7" /></svg>
              )}
              <span class="text-xs font-bold inline-flex items-center gap-0.5" style={`color:${DASHA_COLORS[p.planet] ?? '#334155'}`}><span set:html={planetIconSvg(p.planet, 12)} />{p.planet}</span>
            </Fragment>
          ))}
        </div>
      </div>
    </div>
  </section>

  <!-- Section quick-jump -->
  <nav id="section-nav" class="sticky top-0 z-30 mt-10 mb-8 -mx-4 md:-mx-6 lg:-mx-8 px-4 md:px-6 lg:px-8 py-3 bg-background/80 backdrop-blur-lg border-b border-border" aria-label="Report sections">
    <div class="flex flex-wrap gap-2 md:flex-nowrap">
      {reportTabs.map((tab, i) => (
        <button
          type="button"
          data-section-pill={tab.id}
          class={`section-pill px-4 py-2 rounded-full text-[13px] font-semibold transition-all duration-200 ${i === 0 ? 'bg-primary text-primary-foreground' : 'bg-secondary text-secondary-foreground hover:bg-primary/80 hover:text-primary-foreground'}`}
        >
          {tab.label}
        </button>
      ))}
    </div>
  </nav>
  <script is:inline>
  (function() {
    var pills = document.querySelectorAll('[data-section-pill]');
    var activeClass = 'bg-primary text-primary-foreground';
    var inactiveClass = 'bg-secondary text-secondary-foreground hover:bg-primary/80 hover:text-primary-foreground';

    function setActive(id) {
      pills.forEach(function(p) {
        var isActive = p.getAttribute('data-section-pill') === id;
        activeClass.split(' ').forEach(function(c) { p.classList.toggle(c, isActive); });
        inactiveClass.split(' ').forEach(function(c) { p.classList.toggle(c, !isActive); });
      });
    }

    pills.forEach(function(btn) {
      btn.addEventListener('click', function() {
        var id = btn.getAttribute('data-section-pill');
        var el = document.getElementById(id);
        if (el) {
          setActive(id);
          el.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
      });
    });

    var sectionIds = [];
    pills.forEach(function(p) { sectionIds.push(p.getAttribute('data-section-pill')); });
    var observer = new IntersectionObserver(function(entries) {
      entries.forEach(function(entry) {
        if (entry.isIntersecting) setActive(entry.target.id);
      });
    }, { rootMargin: '-80px 0px -60% 0px', threshold: 0 });
    sectionIds.forEach(function(id) {
      var el = document.getElementById(id);
      if (el) observer.observe(el);
    });
  })();
  </script>

  <!-- 1. Planets (Positions) -->
  <section id="planets" class="pt-2 scroll-mt-16">
    <h2 class="text-lg font-bold text-slate-800 tracking-tight mb-4">Planet Positions</h2>
    <!-- Desktop table -->
    <div class="hidden md:block rounded-xl border border-stone-200/80 bg-white overflow-hidden">
      <table class="w-full text-sm">
        <thead>
          <tr class="bg-stone-50 border-b border-stone-200/80">
            <th class="text-left px-5 py-3 text-xs font-bold text-stone-500 uppercase tracking-wider">Planet</th>
            <th class="text-left px-5 py-3 text-xs font-bold text-stone-500 uppercase tracking-wider">Sign</th>
            <th class="text-center px-5 py-3 text-xs font-bold text-stone-500 uppercase tracking-wider">Degree</th>
            <th class="text-center px-5 py-3 text-xs font-bold text-stone-500 uppercase tracking-wider">House</th>
            <th class="text-center px-5 py-3 text-xs font-bold text-stone-500 uppercase tracking-wider">Status</th>
          </tr>
        </thead>
        <tbody>
          {planetRows.map((p, i) => (
            <tr class={i < planetRows.length - 1 ? 'border-b border-stone-100' : ''}>
              <td class="px-5 py-3">
                <span class="font-bold inline-flex items-center gap-1.5" style={`color:${DASHA_COLORS[p.graha] ?? '#334155'}`}>
                  <span set:html={planetIconSvg(p.graha, 16)} />{p.graha}
                </span>
              </td>
              <td class="px-5 py-3">
                <span class="font-semibold text-stone-700">{p.sign}</span>
                <span class="text-slate-500 text-xs font-medium ml-1.5">({p.signSanskrit})</span>
              </td>
              <td class="px-5 py-3 text-center font-mono font-semibold text-stone-700">{String(p.degree).padStart(2, '0')}°</td>
              <td class="px-5 py-3 text-center font-bold text-stone-600">{p.house}</td>
              <td class="px-5 py-3 text-center">
                {p.retrograde
                  ? <span class="inline-flex items-center gap-1 text-xs font-bold text-red-500 bg-red-50 px-2 py-0.5 rounded-full">R</span>
                  : <span class="text-xs font-semibold text-slate-400">Direct</span>}
              </td>
            </tr>
          ))}
        </tbody>
      </table>
    </div>
    <!-- Mobile cards -->
    <div class="md:hidden space-y-2.5">
      {planetRows.map((p) => (
        <div class="rounded-xl border border-stone-200/80 bg-white px-4 py-3 flex items-center gap-3">
          <span class="shrink-0" style={`color:${DASHA_COLORS[p.graha] ?? '#334155'}`} set:html={planetIconSvg(p.graha, 20)} />
          <div class="flex-1 min-w-0">
            <p class="font-bold text-sm" style={`color:${DASHA_COLORS[p.graha] ?? '#334155'}`}>
              {p.graha}
              {p.retrograde && <span class="ml-1.5 text-[10px] font-bold text-red-500 bg-red-50 px-1.5 py-0.5 rounded-full align-middle">R</span>}
            </p>
            <p class="text-xs text-stone-500 mt-0.5">{p.sign} ({p.signSanskrit})</p>
          </div>
          <div class="text-right shrink-0">
            <p class="text-sm font-mono font-bold text-stone-700">{String(p.degree).padStart(2, '0')}°</p>
            <p class="text-xs font-semibold text-slate-500">House {p.house}</p>
          </div>
        </div>
      ))}
    </div>
  </section>

  <!-- 2. Dasha Timeline (interactive) -->
  <section id="dasha" class="pt-8 scroll-mt-16">
    <h2 class="text-lg font-bold text-slate-800 tracking-tight mb-1">Vimshottari Dasha Timeline</h2>
    <p class="text-xs font-semibold text-slate-500 mb-4">Click any period to drill into Antardasha and Pratyantardasha sub-periods</p>
    <DashaTimeline client:visible mahas={mahasTimeline} colors={DASHA_COLORS} />
  </section>

  <!-- 3. Yogas -->
  <section id="yogas" class="pt-8 scroll-mt-16">
    <h2 class="text-lg font-bold text-slate-800 tracking-tight mb-1">Yogas <span class="text-slate-500 font-normal text-xs">(Planetary Combinations)</span></h2>
    <p class="text-xs font-semibold text-slate-500 mb-5">{yogaResults.length} yoga{yogaResults.length !== 1 ? 's' : ''} found in your chart</p>

    {yogaResults.length === 0 ? (
      <div class="rounded-xl border border-dashed border-slate-300 bg-slate-50/50 p-6 text-center">
        <p class="text-sm font-bold text-slate-600">No prominent yogas detected</p>
        <p class="text-xs text-slate-500 mt-1">This is rare — most charts have at least one yoga</p>
      </div>
    ) : (
      <div class="space-y-8">
        {categoryOrder.map(cat => {
          const yogas = yogasByCategory.get(cat);
          if (!yogas || yogas.length === 0) return null;
          const isDosha = cat === 'dosha';
          return (
            <div>
              <div class="mb-3">
                <h3 class={`text-sm font-bold uppercase tracking-wide ${isDosha ? 'text-red-600' : 'text-slate-800'}`}>{YOGA_CATEGORY_LABELS[cat]}</h3>
                <p class="text-xs text-slate-600 mt-0.5">{yogaCatDesc[cat]}</p>
              </div>
              <div class="space-y-3">
                {yogas.map(yoga => {
                  const sColor = isDosha
                    ? (yoga.strength === 'strong' ? '#dc2626' : yoga.strength === 'moderate' ? '#f97316' : '#64748b')
                    : (yoga.strength === 'strong' ? '#059669' : yoga.strength === 'moderate' ? '#3b82f6' : '#64748b');
                  const sLabel = isDosha
                    ? (yoga.strength === 'strong' ? 'Significant' : yoga.strength === 'moderate' ? 'Present' : 'Mild')
                    : (yoga.strength === 'strong' ? 'Very Powerful' : yoga.strength === 'moderate' ? 'Active' : 'Mild');
                  const bars = yoga.strength === 'strong' ? 3 : yoga.strength === 'moderate' ? 2 : 1;
                  return (
                  <div class={`rounded-xl border overflow-hidden ${isDosha ? 'border-red-200/60 bg-red-50/30' : 'border-slate-200/80 bg-white'}`}>
                    <div class="px-4 py-4">
                      <div class="flex-1 min-w-0">
                        <div class="flex items-center gap-2 flex-wrap">
                          <span class={`text-[15px] font-bold tracking-tight ${isDosha ? 'text-red-700' : 'text-slate-900'}`}>{yoga.name}</span>
                          {yoga.sanskrit && <span class="text-sm text-slate-500 font-medium">{yoga.sanskrit}</span>}
                          <span class="flex items-center gap-1.5 ml-auto sm:ml-0">
                            <span class="flex items-end gap-[3px]" title={sLabel}>
                              {[1, 2, 3].map(n => (
                                <span class={`w-[4px] rounded-sm ${n === 1 ? 'h-[8px]' : n === 2 ? 'h-[12px]' : 'h-[16px]'}`}
                                  style={`background:${n <= bars ? sColor : '#cbd5e1'}`} />
                              ))}
                            </span>
                            <span class="text-xs font-bold" style={`color:${sColor}`}>{sLabel}</span>
                          </span>
                        </div>
                        <p class="text-sm text-slate-600 mt-1.5 font-medium">{yoga.description}</p>
                        <p class="text-sm text-slate-800 mt-1.5 leading-relaxed">{yoga.effect}</p>

                        <div class="flex items-center gap-2 mt-3 flex-wrap">
                          {yoga.planets.map(planet => (
                            <span class="text-xs font-bold px-2.5 py-1 rounded-md bg-slate-50 border border-slate-200 inline-flex items-center gap-1" style={`color:${DASHA_COLORS[planet] ?? '#334155'}`}>
                              <span set:html={planetIconSvg(planet, 14)} />{planet}
                            </span>
                          ))}
                          {yoga.houses.length > 0 && (
                            <span class="text-xs font-bold text-slate-500">H{[...new Set(yoga.houses)].join(', H')}</span>
                          )}
                        </div>

                        {yoga.detail && (
                          <details class="mt-3 group">
                            <summary class={`text-sm font-semibold cursor-pointer select-none list-none flex items-center gap-1.5 ${isDosha ? 'text-red-500 hover:text-red-700' : 'text-blue-600 hover:text-blue-800'} transition-colors`}>
                              <svg class="w-4 h-4 shrink-0 transition-transform group-open:rotate-90" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg>
                              Learn more about this yoga
                            </summary>
                            <div class={`mt-2.5 pl-5 border-l-2 ${isDosha ? 'border-red-200' : 'border-slate-200'}`}>
                              <p class="text-sm text-slate-700 leading-relaxed">{yoga.detail}</p>
                            </div>
                          </details>
                        )}
                      </div>
                    </div>
                  </div>
                  );
                })}
              </div>
            </div>
          );
        })}
      </div>
    )}
  </section>

  <!-- 4. Transits (Gochar) -->
  <section id="transits" class="pt-8 scroll-mt-16">
    <h2 class="text-lg font-bold text-slate-800 tracking-tight mb-1">Transits <span class="text-slate-500 font-normal text-sm">(Gochar)</span></h2>
    <p class="text-sm text-slate-600 mb-5">Where planets are on any date and how they affect your natal houses</p>

    <TransitSection
      client:visible
      initialTransit={transitResult}
      natalLagna={chartData.lagna}
    />
  </section>

  <!-- 5. Divisional Charts (Varga) -->
  <section id="divisional" class="pt-8 pb-4 scroll-mt-16">
    <h2 class="text-lg font-bold text-foreground tracking-tight mb-1">Divisional Charts <span class="text-muted-foreground font-normal text-sm">(Varga)</span></h2>
    <p class="text-sm text-muted-foreground mb-4">Each chart zooms into a specific life area by subdividing the zodiac — {vargaCharts.length} charts computed</p>

    <!-- Sticky pills for divisional chart navigation -->
    <div class="sticky top-[52px] z-20 -mx-4 md:-mx-6 lg:-mx-8 px-4 md:px-6 lg:px-8 py-2.5 bg-background/90 backdrop-blur-lg border-b border-border mb-5">
      <div class="flex flex-wrap gap-1.5">
        {vargaCharts.map(vc => {
          const shortPurpose = vc.def.purpose.split('&')[0].split(',')[0].trim();
          return (
            <button
              type="button"
              data-varga-pill={vc.def.id}
              class="varga-pill px-3 py-1.5 rounded-full text-xs font-bold transition-all duration-200 bg-secondary text-secondary-foreground hover:bg-primary/80 hover:text-primary-foreground">
              {vc.def.id} <span class="font-medium ml-0.5">{shortPurpose}</span>
            </button>
          );
        })}
      </div>
    </div>
    <script is:inline>
    (function() {
      var pills = document.querySelectorAll('[data-varga-pill]');
      var activeClass = 'bg-primary text-primary-foreground';
      var inactiveClass = 'bg-secondary text-secondary-foreground hover:bg-primary/80 hover:text-primary-foreground';

      function setVargaActive(id) {
        pills.forEach(function(p) {
          var isActive = p.getAttribute('data-varga-pill') === id;
          activeClass.split(' ').forEach(function(c) { p.classList.toggle(c, isActive); });
          inactiveClass.split(' ').forEach(function(c) { p.classList.toggle(c, !isActive); });
        });
      }

      pills.forEach(function(btn) {
        btn.addEventListener('click', function() {
          var id = btn.getAttribute('data-varga-pill');
          var el = document.getElementById('varga-' + id);
          if (!el) return;
          setVargaActive(id);
          if (!el.open) el.open = true;
          setTimeout(function() {
            el.scrollIntoView({ behavior: 'smooth', block: 'start' });
          }, 50);
        });
      });
    })();
    </script>

    <div class="space-y-4">
      {vargaCharts.map(vc => {
        const vcChartData = vargaToChartData(vc);
        return (
        <details id={`varga-${vc.def.id}`} class="rounded-xl border border-border overflow-hidden scroll-mt-[120px] group">
          <summary class="px-5 py-5 cursor-pointer select-none list-none flex items-start gap-3 bg-card">
            <div class="flex-1 min-w-0">
              <div class="flex items-center gap-2.5 flex-wrap">
                <span class="text-sm font-bold px-2.5 py-1 rounded-lg bg-secondary text-secondary-foreground">{vc.def.id}</span>
                <span class="text-lg font-bold tracking-tight text-foreground">{vc.def.purpose}</span>
              </div>
              <p class="text-sm text-muted-foreground mt-1">{vc.def.name} {vc.def.sanskrit} · Lagna {RASHI_ENGLISH[vc.lagna] ?? vc.lagna}</p>
              <p class="text-[15px] text-muted-foreground mt-2 leading-relaxed">{vc.def.description}</p>
            </div>
            <svg class="w-5 h-5 text-muted-foreground shrink-0 mt-1.5 transition-transform group-open:rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
          </summary>

          <div class="border-t border-border bg-card">
            <!-- Diamond chart -->
            <div class="px-5 py-4">
              <div class="mx-auto max-w-md">
                <NorthIndianChart client:visible chartData={vcChartData} showEnglishSigns={true} />
              </div>
            </div>

            <!-- Planet positions -->
            <div class="px-5 pb-5">
              <!-- Desktop table -->
              <div class="hidden md:block rounded-xl border border-border overflow-hidden">
                <table class="w-full text-sm">
                  <thead>
                    <tr class="bg-secondary border-b border-border">
                      <th class="text-left px-5 py-2.5 text-xs font-bold text-muted-foreground uppercase tracking-wider">Planet</th>
                      <th class="text-left px-5 py-2.5 text-xs font-bold text-muted-foreground uppercase tracking-wider">Sign</th>
                      <th class="text-center px-5 py-2.5 text-xs font-bold text-muted-foreground uppercase tracking-wider">Degree</th>
                      <th class="text-center px-5 py-2.5 text-xs font-bold text-muted-foreground uppercase tracking-wider">House</th>
                    </tr>
                  </thead>
                  <tbody>
                    {vc.planets.sort((a, b) => PLANET_ORDER.indexOf(a.graha) - PLANET_ORDER.indexOf(b.graha)).map((p, i) => (
                      <tr class={i < vc.planets.length - 1 ? 'border-b border-border/50' : ''}>
                        <td class="px-5 py-2.5">
                          <span class="font-bold inline-flex items-center gap-1.5" style={`color:${DASHA_COLORS[p.graha] ?? '#334155'}`}>
                            <span set:html={planetIconSvg(p.graha, 16)} />{p.graha}
                            {p.retrograde && <span class="text-[10px] font-bold text-red-500 bg-red-50 px-1.5 py-0.5 rounded-full">R</span>}
                          </span>
                        </td>
                        <td class="px-5 py-2.5 font-semibold text-foreground">{RASHI_ENGLISH[p.rashi] ?? p.rashi}</td>
                        <td class="px-5 py-2.5 text-center font-mono font-semibold text-foreground">{String(p.degree).padStart(2, '0')}°</td>
                        <td class="px-5 py-2.5 text-center font-bold text-muted-foreground">{p.house}</td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
              <!-- Mobile grid -->
              <div class="md:hidden grid grid-cols-3 gap-2">
                {vc.planets.sort((a, b) => PLANET_ORDER.indexOf(a.graha) - PLANET_ORDER.indexOf(b.graha)).map(p => (
                  <div class="rounded-lg bg-secondary border border-border px-3 py-2.5 text-center">
                    <p class="text-xs font-bold inline-flex items-center justify-center gap-1" style={`color:${DASHA_COLORS[p.graha] ?? '#334155'}`}>
                      <span set:html={planetIconSvg(p.graha, 13)} />{p.graha}{p.retrograde ? <span class="text-red-500 ml-0.5">R</span> : ''}
                    </p>
                    <p class="text-xs text-muted-foreground font-semibold mt-0.5">{RASHI_ENGLISH[p.rashi] ?? p.rashi}</p>
                    <p class="text-[11px] text-muted-foreground font-medium">H{p.house} · {p.degree}°</p>
                  </div>
                ))}
              </div>
            </div>
          </div>
        </details>
        );
      })}
    </div>
  </section>

  <!-- Bottom actions -->
  <div class="mt-12 mb-4 rounded-xl border border-border bg-card px-5 py-6 text-center">
    <p class="text-card-foreground font-semibold text-base mb-1">That's your complete Vedic birth chart</p>
    <p class="text-muted-foreground text-sm mb-5">Share it with someone or save a PDF copy for your records</p>
    <div class="flex flex-wrap items-center justify-center gap-3">
      <ShareButton client:visible chartId={chartId} userName={name} />
      <DownloadPdfButton client:visible userName={name} />
      <a href="/kundli" class="text-muted-foreground hover:text-foreground text-sm font-semibold px-4 py-2 rounded-lg hover:bg-accent transition-colors">
        Generate New Chart
      </a>
    </div>
  </div>
</ReportLayout>
