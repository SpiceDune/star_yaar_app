---
import ReportLayout from '../../layouts/ReportLayout.astro';
import KundliForm from '../../components/form/KundliForm';
import NorthIndianChart from '../../components/charts/NorthIndianChart';
import DashaTimeline from '../../components/report/DashaTimeline';
import { getPanchangByDate } from '../../lib/db/panchang';
import { getCityLatLon } from '../../lib/db/cities';
import { computeKundli } from '../../lib/compute-kundli';
import { mockChartD1, mockPanchang, mockDasha } from '../../lib/mock-data';
import { RASHI_ENGLISH } from '../../lib/constants';
import type { ChartData, Panchang as PanchangType, GrahaId, RashiId } from '../../lib/types';

const MONTHS = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
function formatDOB(iso: string | undefined): string {
  if (!iso) return '';
  const [y, m, d] = iso.split('-').map(Number);
  if (!d || !m) return iso;
  return `${d} ${MONTHS[m - 1]} ${y}`;
}

const cookie = (key: string) => Astro.cookies.get(`kundli_${key}`)?.value ?? undefined;
const name = cookie('name') || Astro.url.searchParams.get('name') || 'Sample User';
const dobRaw = cookie('dob') || Astro.url.searchParams.get('dob') || '1981-05-31';
const timeCookie = cookie('time') || Astro.url.searchParams.get('time') || '';
const timeOfBirth = timeCookie || '10:30 AM';
const city = cookie('city') || Astro.url.searchParams.get('city') || 'Mumbai, India';
const formattedDOB = formatDOB(dobRaw) || '31 May 1981';
const timeForCompute = timeCookie.replace(/\s*(AM|PM)$/i, '').trim() || '12:00';

let panchangData: PanchangType = mockPanchang;
const panchangFromDb = dobRaw ? await getPanchangByDate(dobRaw) : null;
if (panchangFromDb) panchangData = panchangFromDb;

let chartData: ChartData = mockChartD1;
let dashaData = mockDasha;
const latCookie = cookie('lat');
const lonCookie = cookie('lon');
const tzCookie = cookie('tz');
let cityLoc: { lat: number; lon: number; timezone?: string } | null = null;
if (latCookie != null && lonCookie != null && !Number.isNaN(Number(latCookie)) && !Number.isNaN(Number(lonCookie))) {
  cityLoc = { lat: Number(latCookie), lon: Number(lonCookie), timezone: tzCookie };
}
if (!cityLoc) cityLoc = await getCityLatLon(city);
if (cityLoc && dobRaw) {
  const computed = await computeKundli({
    dob: dobRaw,
    time: timeForCompute,
    lat: cityLoc.lat,
    lon: cityLoc.lon,
    timezone: cityLoc.timezone || 'Asia/Kolkata',
  });
  if (computed) {
    chartData = computed.chartData;
    dashaData = computed.dasha;
  }
}

const DASHA_COLORS: Record<string, string> = {
  Sun: '#ea580c', Moon: '#7c3aed', Mars: '#e11d48', Mercury: '#059669',
  Jupiter: '#d97706', Venus: '#ec4899', Saturn: '#475569',
  Rahu: '#2563eb', Ketu: '#6366f1',
};

// ── Derived data for sections ──

// Planet positions table
interface PlanetRow {
  graha: GrahaId;
  sign: string;
  signSanskrit: string;
  degree: number;
  house: number;
  retrograde: boolean;
}
const planetRows: PlanetRow[] = [];
const PLANET_ORDER: GrahaId[] = ['Sun','Moon','Mars','Mercury','Jupiter','Venus','Saturn','Rahu','Ketu'];
for (let h = 1; h <= 12; h++) {
  const house = chartData.houses[h];
  if (!house?.planets) continue;
  for (const p of house.planets) {
    planetRows.push({
      graha: p.graha,
      sign: RASHI_ENGLISH[house.rashi] ?? String(house.rashi),
      signSanskrit: String(house.rashi),
      degree: p.degree,
      house: h,
      retrograde: p.retrograde ?? false,
    });
  }
}
planetRows.sort((a, b) => PLANET_ORDER.indexOf(a.graha) - PLANET_ORDER.indexOf(b.graha));

// Vimshottari Dasha full timeline computation
const VIMSHOTTARI_SEQ = ['Ketu','Venus','Sun','Moon','Mars','Rahu','Jupiter','Saturn','Mercury'];
const VIMSHOTTARI_YEARS: Record<string, number> = {
  Ketu: 7, Venus: 20, Sun: 6, Moon: 10, Mars: 7, Rahu: 18, Jupiter: 16, Saturn: 19, Mercury: 17,
};
const _MS_YEAR = 365.25 * 24 * 3600 * 1000;

function _parseDate(s: string): number {
  const parts = s.split(' ');
  if (parts.length !== 3) return Date.now();
  return new Date(Number(parts[2]), MONTHS.indexOf(parts[1]), Number(parts[0])).getTime();
}
function _fmtDate(ms: number): string {
  const dt = new Date(ms);
  return `${dt.getDate()} ${MONTHS[dt.getMonth()]} ${dt.getFullYear()}`;
}
function _fmtDur(y: number): string {
  if (y >= 1) return `${y.toFixed(1)}y`;
  const m = y * 12;
  if (m >= 1) return `${Math.round(m)}m`;
  return `${Math.round(y * 365)}d`;
}

const _curMaha = dashaData.periods[0]?.planet ?? '';
const _curAntar = dashaData.periods[1]?.planet ?? '';
const _curMahaStartMs = _parseDate(dashaData.periods[0]?.start ?? '');
const _curMahaEndMs = _parseDate(dashaData.periods[0]?.end ?? '');
const _curMahaIdx = VIMSHOTTARI_SEQ.indexOf(_curMaha);
const _nowMs = Date.now();

// Build 17 Maha Dasha periods (8 before + current + 8 after)
const _allMaha: { planet: string; startMs: number; endMs: number; years: number }[] = [];
const _back: typeof _allMaha = [];
let _bc = _curMahaStartMs;
for (let i = 1; i <= 8; i++) {
  const idx = ((_curMahaIdx - i) % 9 + 9) % 9;
  const p = VIMSHOTTARI_SEQ[idx];
  const yr = VIMSHOTTARI_YEARS[p];
  const e = _bc; const s = e - yr * _MS_YEAR;
  _back.unshift({ planet: p, startMs: s, endMs: e, years: yr });
  _bc = s;
}
_allMaha.push(..._back);
_allMaha.push({ planet: _curMaha, startMs: _curMahaStartMs, endMs: _curMahaEndMs, years: VIMSHOTTARI_YEARS[_curMaha] ?? 0 });
let _fc = _curMahaEndMs;
for (let i = 1; i <= 8; i++) {
  const idx = (_curMahaIdx + i) % 9;
  const p = VIMSHOTTARI_SEQ[idx];
  const yr = VIMSHOTTARI_YEARS[p];
  const s = _fc; const e = s + yr * _MS_YEAR;
  _allMaha.push({ planet: p, startMs: s, endMs: e, years: yr });
  _fc = e;
}

// Pick 9 from birth onward
const [_by, _bm, _bd] = dobRaw.split('-').map(Number);
const _birthMs = new Date(_by, _bm - 1, _bd).getTime();
let _fi = _allMaha.findIndex(e => e.startMs <= _birthMs && e.endMs > _birthMs);
if (_fi < 0) _fi = Math.max(0, _allMaha.length - 9);
const _lifeMahas = _allMaha.slice(_fi, _fi + 9);

// Build full timeline with Antardashas
import type { MahaEntry, AntarEntry } from '../../components/report/DashaTimeline';
const mahasTimeline: MahaEntry[] = _lifeMahas.map(maha => {
  const mIdx = VIMSHOTTARI_SEQ.indexOf(maha.planet);
  const antars: AntarEntry[] = [];
  let ac = maha.startMs;
  for (let i = 0; i < 9; i++) {
    const idx = (mIdx + i) % 9;
    const p = VIMSHOTTARI_SEQ[idx];
    const durY = (maha.years * (VIMSHOTTARI_YEARS[p] ?? 0)) / 120;
    const durMs = durY * _MS_YEAR;
    const s = ac; const e = ac + durMs;
    antars.push({
      planet: p,
      duration: _fmtDur(durY),
      startMs: s,
      endMs: e,
      start: _fmtDate(s),
      end: _fmtDate(e),
      isCurrent: maha.planet === _curMaha && p === _curAntar && s <= _nowMs && e > _nowMs,
      mahaYears: maha.years,
    });
    ac = e;
  }
  return {
    planet: maha.planet,
    years: maha.years,
    start: _fmtDate(maha.startMs),
    end: _fmtDate(maha.endMs),
    isCurrent: maha.planet === _curMaha,
    antars,
  };
});

const reportTabs = [
  { id: 'planets', label: 'Planets' },
  { id: 'dasha', label: 'Dasha Timeline' },
  { id: 'yogas', label: 'Yogas' },
  { id: 'transits', label: 'Transits' },
  { id: 'd9', label: 'D9 Navamsa' },
  { id: 'divisional', label: 'Divisional Charts' },
];
---

<ReportLayout title="Birth Chart | StarYaar" wide={true}>
  <!-- Status banner -->
  <div class="bg-white border border-stone-200/80 rounded-xl px-4 md:px-5 py-3 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 mb-6 md:mb-8">
    <p class="text-stone-700 font-medium text-sm">
      {name && name !== 'Sample User' ? `${name}'s birth chart is ready` : 'Birth chart report is ready'}
    </p>
    <div class="flex flex-wrap items-center gap-2">
      <a href="/" class="text-stone-500 hover:text-stone-700 text-xs font-medium px-3 py-1.5 rounded-lg hover:bg-stone-100 transition-colors">
        New chart
      </a>
      <a href="#" class="inline-flex items-center gap-1.5 rounded-lg bg-stone-800 hover:bg-stone-900 text-white font-semibold text-xs px-3.5 py-2 transition-colors">
        <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
        </svg>
        Export
      </a>
    </div>
  </div>

  <!-- Collapsible form -->
  <details class="mb-6 md:mb-8 group">
    <summary class="text-sm font-semibold text-stone-500 cursor-pointer flex items-center gap-2 hover:text-stone-700 transition-colors">
      <svg class="w-4 h-4 transition-transform group-open:rotate-90" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg>
      Generate another Kundli
    </summary>
    <div class="mt-4">
      <KundliForm client:load variant="compact" />
    </div>
  </details>

  <!-- Main grid: Chart + Panchang/Dasha -->
  <section class="grid grid-cols-1 lg:grid-cols-[1fr_380px] gap-6 md:gap-8">
    <div class="rounded-xl border border-stone-200/80 bg-white p-5 md:p-6">
      <NorthIndianChart client:visible chartData={chartData} large={true} showEnglishSigns={true} />
    </div>

    <div class="flex flex-col gap-5 md:gap-6">
      <!-- Panchang -->
      <div class="rounded-xl border border-stone-200/80 bg-white p-5">
        <h2 class="text-base font-bold text-slate-800 tracking-tight mb-4">Panchang <span class="text-slate-500 font-normal text-xs">(Five Limbs)</span></h2>
        <dl class="space-y-0">
          {[
            { k: 'Tithi', v: panchangData.tithi },
            { k: 'Nakshatra', v: `${panchangData.nakshatra}${panchangData.nakshatraPada ? ` (${panchangData.nakshatraPada})` : ''}` },
            { k: 'Yoga', v: panchangData.yoga },
            { k: 'Karana', v: panchangData.karana },
            { k: 'Vara', v: panchangData.vara },
          ].map((item, i) => (
            <div class={`flex justify-between items-center py-2.5 ${i < 4 ? 'border-b border-slate-100' : ''}`}>
              <dt class="text-xs font-semibold text-slate-500 uppercase tracking-wider">{item.k}</dt>
              <dd class="text-sm font-bold text-slate-700">{item.v}</dd>
            </div>
          ))}
        </dl>
      </div>

      <!-- Dasha -->
      <div class="rounded-xl border border-stone-200/80 bg-white p-5">
        <h2 class="text-base font-bold text-slate-800 tracking-tight mb-4">Current Dasha Period</h2>
        <div class="space-y-3">
          {dashaData.periods.map((period) => {
            const col = DASHA_COLORS[period.planet] ?? '#334155';
            return (
              <div class="flex items-center gap-4 rounded-lg bg-slate-50 px-4 py-3">
                <div class="shrink-0 w-2.5 h-10 rounded-full" style={`background:${col}`} />
                <div class="min-w-0 flex-1">
                  <p class="text-[11px] font-bold uppercase tracking-widest text-slate-500 leading-none mb-1">{period.label}</p>
                  <p class="text-lg font-extrabold tracking-tight leading-tight" style={`color:${col}`}>{period.planet}</p>
                </div>
                <div class="text-right shrink-0">
                  <p class="text-sm font-bold text-slate-700">{period.duration}</p>
                  <p class="text-xs font-semibold text-slate-500 mt-0.5">{period.start} — {period.end}</p>
                </div>
              </div>
            );
          })}
        </div>
        <div class="mt-3 flex items-center gap-1.5 text-sm font-bold text-slate-600">
          {dashaData.periods.map((p, i) => (
            <Fragment>
              {i > 0 && <span class="text-slate-300">→</span>}
              <span style={`color:${DASHA_COLORS[p.planet] ?? '#334155'}`}>{p.planet}</span>
            </Fragment>
          ))}
        </div>
      </div>
    </div>
  </section>

  <!-- Section quick-jump -->
  <nav class="sticky top-0 z-30 mt-10 mb-8 -mx-4 md:-mx-6 lg:-mx-8 px-4 md:px-6 lg:px-8 py-3 bg-white/80 backdrop-blur-lg border-b border-slate-200/60" aria-label="Report sections">
    <div class="flex flex-wrap gap-2 md:flex-nowrap">
      {reportTabs.map((tab) => (
        <a
          href={`#${tab.id}`}
          class="px-4 py-2 rounded-full text-[13px] font-semibold text-slate-600 bg-slate-100 hover:bg-slate-800 hover:text-white transition-all duration-200"
        >
          {tab.label}
        </a>
      ))}
    </div>
  </nav>

  <!-- 1. Planets (Positions) -->
  <section id="planets" class="pt-2 scroll-mt-16">
    <h2 class="text-lg font-bold text-slate-800 tracking-tight mb-4">Planet Positions</h2>
    <!-- Desktop table -->
    <div class="hidden md:block rounded-xl border border-stone-200/80 bg-white overflow-hidden">
      <table class="w-full text-sm">
        <thead>
          <tr class="bg-stone-50 border-b border-stone-200/80">
            <th class="text-left px-5 py-3 text-xs font-bold text-stone-500 uppercase tracking-wider">Planet</th>
            <th class="text-left px-5 py-3 text-xs font-bold text-stone-500 uppercase tracking-wider">Sign</th>
            <th class="text-center px-5 py-3 text-xs font-bold text-stone-500 uppercase tracking-wider">Degree</th>
            <th class="text-center px-5 py-3 text-xs font-bold text-stone-500 uppercase tracking-wider">House</th>
            <th class="text-center px-5 py-3 text-xs font-bold text-stone-500 uppercase tracking-wider">Status</th>
          </tr>
        </thead>
        <tbody>
          {planetRows.map((p, i) => (
            <tr class={i < planetRows.length - 1 ? 'border-b border-stone-100' : ''}>
              <td class="px-5 py-3">
                <span class="font-bold" style={`color:${DASHA_COLORS[p.graha] ?? '#334155'}`}>{p.graha}</span>
              </td>
              <td class="px-5 py-3">
                <span class="font-semibold text-stone-700">{p.sign}</span>
                <span class="text-slate-500 text-xs font-medium ml-1.5">({p.signSanskrit})</span>
              </td>
              <td class="px-5 py-3 text-center font-mono font-semibold text-stone-700">{String(p.degree).padStart(2, '0')}°</td>
              <td class="px-5 py-3 text-center font-bold text-stone-600">{p.house}</td>
              <td class="px-5 py-3 text-center">
                {p.retrograde
                  ? <span class="inline-flex items-center gap-1 text-xs font-bold text-red-500 bg-red-50 px-2 py-0.5 rounded-full">R</span>
                  : <span class="text-xs font-semibold text-slate-400">Direct</span>}
              </td>
            </tr>
          ))}
        </tbody>
      </table>
    </div>
    <!-- Mobile cards -->
    <div class="md:hidden space-y-2.5">
      {planetRows.map((p) => (
        <div class="rounded-xl border border-stone-200/80 bg-white px-4 py-3 flex items-center gap-3">
          <div class="shrink-0 w-2 h-8 rounded-full" style={`background:${DASHA_COLORS[p.graha] ?? '#334155'}`} />
          <div class="flex-1 min-w-0">
            <p class="font-bold text-sm" style={`color:${DASHA_COLORS[p.graha] ?? '#334155'}`}>
              {p.graha}
              {p.retrograde && <span class="ml-1.5 text-[10px] font-bold text-red-500 bg-red-50 px-1.5 py-0.5 rounded-full align-middle">R</span>}
            </p>
            <p class="text-xs text-stone-500 mt-0.5">{p.sign} ({p.signSanskrit})</p>
          </div>
          <div class="text-right shrink-0">
            <p class="text-sm font-mono font-bold text-stone-700">{String(p.degree).padStart(2, '0')}°</p>
            <p class="text-xs font-semibold text-slate-500">House {p.house}</p>
          </div>
        </div>
      ))}
    </div>
  </section>

  <!-- 2. Dasha Timeline (interactive) -->
  <section id="dasha" class="pt-8 scroll-mt-16">
    <h2 class="text-lg font-bold text-slate-800 tracking-tight mb-1">Vimshottari Dasha Timeline</h2>
    <p class="text-xs font-semibold text-slate-500 mb-4">Click any period to drill into Antardasha and Pratyantardasha sub-periods</p>
    <DashaTimeline client:visible mahas={mahasTimeline} colors={DASHA_COLORS} />
  </section>

  <!-- 3. Yogas -->
  <section id="yogas" class="pt-8 scroll-mt-16">
    <h2 class="text-lg font-bold text-slate-800 tracking-tight mb-4">Yogas <span class="text-slate-500 font-normal text-xs">(Combinations)</span></h2>
    <div class="rounded-xl border border-dashed border-slate-300 bg-slate-50/50 p-6 md:p-8 text-center">
      <div class="w-10 h-10 rounded-full bg-slate-100 flex items-center justify-center mx-auto mb-3">
        <svg class="w-5 h-5 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" /></svg>
      </div>
      <p class="text-sm font-bold text-slate-700 mb-1">Coming Soon</p>
      <p class="text-xs font-medium text-slate-500 max-w-sm mx-auto">Yoga analysis identifies special planetary combinations in your chart — Raj Yoga, Dhan Yoga, Gajakesari, and more.</p>
    </div>
  </section>

  <!-- 4. Transits -->
  <section id="transits" class="pt-8 scroll-mt-16">
    <h2 class="text-lg font-bold text-slate-800 tracking-tight mb-4">Transits <span class="text-slate-500 font-normal text-xs">(Gochar)</span></h2>
    <div class="rounded-xl border border-dashed border-slate-300 bg-slate-50/50 p-6 md:p-8 text-center">
      <div class="w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center mx-auto mb-3">
        <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" /></svg>
      </div>
      <p class="text-sm font-bold text-slate-700 mb-1">Coming Soon</p>
      <p class="text-xs font-medium text-slate-500 max-w-sm mx-auto">Current planetary transits over your natal chart — see how today's sky affects your houses and dashas.</p>
    </div>
  </section>

  <!-- 5. D9 Navamsa -->
  <section id="d9" class="pt-8 scroll-mt-16">
    <h2 class="text-lg font-bold text-slate-800 tracking-tight mb-4">D9 Navamsa <span class="text-slate-500 font-normal text-xs">(Marriage & Dharma)</span></h2>
    <div class="rounded-xl border border-dashed border-slate-300 bg-slate-50/50 p-6 md:p-8 text-center">
      <div class="w-10 h-10 rounded-full bg-pink-100 flex items-center justify-center mx-auto mb-3">
        <svg class="w-5 h-5 text-pink-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" /></svg>
      </div>
      <p class="text-sm font-bold text-slate-700 mb-1">Coming Soon</p>
      <p class="text-xs font-medium text-slate-500 max-w-sm mx-auto">The Navamsa chart reveals the deeper strength of planets and is key for marriage, spiritual life, and inner nature.</p>
    </div>
  </section>

  <!-- 6. Divisional Charts -->
  <section id="divisional" class="pt-8 pb-4 scroll-mt-16">
    <h2 class="text-lg font-bold text-slate-800 tracking-tight mb-4">Divisional Charts <span class="text-slate-500 font-normal text-xs">(D2–D10)</span></h2>
    <div class="rounded-xl border border-dashed border-slate-300 bg-slate-50/50 p-6 md:p-8 text-center">
      <div class="w-10 h-10 rounded-full bg-violet-100 flex items-center justify-center mx-auto mb-3">
        <svg class="w-5 h-5 text-violet-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 5a1 1 0 011-1h14a1 1 0 011 1v2a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM4 13a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H5a1 1 0 01-1-1v-6zM16 13a1 1 0 011-1h2a1 1 0 011 1v6a1 1 0 01-1 1h-2a1 1 0 01-1-1v-6z" /></svg>
      </div>
      <p class="text-sm font-bold text-slate-700 mb-1">Coming Soon</p>
      <p class="text-xs font-medium text-slate-500 max-w-sm mx-auto">Hora (D2 – wealth), Drekkana (D3 – siblings), Chaturthamsa (D4 – property), Dashamsa (D10 – career), and more.</p>
    </div>
  </section>
</ReportLayout>
